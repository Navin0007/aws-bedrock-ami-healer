name: Terraform Destroy

on:
  workflow_dispatch:
    inputs:
      confirm_destroy:
        description: 'Type "destroy" to confirm'
        required: true
        type: string

jobs:
  destroy:
    name: Terraform Destroy
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Validate confirmation
        run: |
          if [ "${{ github.event.inputs.confirm_destroy }}" != "destroy" ]; then
            echo "âŒ Destroy not confirmed. You must type 'destroy' to proceed."
            exit 1
          fi
          echo "âœ… Destroy confirmed"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Secrets
        run: |
          if [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then
            echo "âŒ Error: AWS_ACCESS_KEY_ID secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then
            echo "âŒ Error: AWS_SECRET_ACCESS_KEY secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.AWS_REGION }}" ]; then
            echo "âŒ Error: AWS_REGION secret is not set"
            exit 1
          fi
          echo "âœ… All required secrets are set"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Get AWS Account ID and Set Bucket Name
        id: backend-config
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          BUCKET_NAME="ami-healer-terraform-state-${ACCOUNT_ID}"
          TABLE_NAME="${{ secrets.TF_STATE_LOCK_TABLE }}"
          
          if [ -z "${{ secrets.TF_STATE_BUCKET }}" ]; then
            echo "âš ï¸  TF_STATE_BUCKET secret not set, using computed bucket name: ${BUCKET_NAME}"
            FINAL_BUCKET="${BUCKET_NAME}"
          else
            echo "âœ… Using TF_STATE_BUCKET secret"
            FINAL_BUCKET="${{ secrets.TF_STATE_BUCKET }}"
          fi
          
          if [ -z "${TABLE_NAME}" ]; then
            echo "âš ï¸  TF_STATE_LOCK_TABLE secret not set, using default: ami-healer-terraform-locks"
            FINAL_TABLE="ami-healer-terraform-locks"
          else
            FINAL_TABLE="${TABLE_NAME}"
          fi
          
          echo "bucket=${FINAL_BUCKET}" >> $GITHUB_OUTPUT
          echo "table=${FINAL_TABLE}" >> $GITHUB_OUTPUT
          echo "region=${{ secrets.AWS_REGION }}" >> $GITHUB_OUTPUT
          
          # Check if bucket exists
          if aws s3api head-bucket --bucket "${FINAL_BUCKET}" 2>/dev/null; then
            echo "âœ… S3 bucket ${FINAL_BUCKET} exists"
          else
            echo "âŒ Error: S3 bucket ${FINAL_BUCKET} does not exist"
            echo "Cannot destroy infrastructure without state bucket."
            exit 1
          fi

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: terraform
        run: |
          terraform init \
            -backend-config="bucket=${{ steps.backend-config.outputs.bucket }}" \
            -backend-config="region=${{ steps.backend-config.outputs.region }}" \
            -backend-config="dynamodb_table=${{ steps.backend-config.outputs.table }}"

      - name: Get Resource Names Before Destroy
        working-directory: terraform
        id: pre-destroy
        run: |
          # Get ALB name if it exists
          ALB_NAME=$(terraform output -raw alb_dns_name 2>/dev/null | cut -d'.' -f1 || echo "")
          ASG_NAME=$(terraform output -raw asg_name 2>/dev/null || echo "")
          VPC_ID=$(terraform output -raw vpc_id 2>/dev/null || echo "")
          
          echo "alb_name=${ALB_NAME}" >> $GITHUB_OUTPUT
          echo "asg_name=${ASG_NAME}" >> $GITHUB_OUTPUT
          echo "vpc_id=${VPC_ID}" >> $GITHUB_OUTPUT
          
          echo "Resources to be destroyed:"
          echo "  ALB: ${ALB_NAME}"
          echo "  ASG: ${ASG_NAME}"
          echo "  VPC: ${VPC_ID}"
        continue-on-error: true

      - name: Terraform Destroy
        working-directory: terraform
        run: terraform destroy -auto-approve -var="manage_backend_resources=false"

      - name: Verify ALB is Destroyed
        run: |
          echo "ðŸ” Verifying ALB is destroyed..."
          
          if [ -n "${{ steps.pre-destroy.outputs.alb_name }}" ]; then
            ALB_NAME="${{ steps.pre-destroy.outputs.alb_name }}"
            # Try to find the ALB
            ALB_ARN=$(aws elbv2 describe-load-balancers \
              --region "${{ steps.backend-config.outputs.region }}" \
              --query "LoadBalancers[?contains(LoadBalancerName, 'ami-healer')].LoadBalancerArn" \
              --output text 2>/dev/null || echo "")
            
            if [ -n "$ALB_ARN" ]; then
              echo "âŒ ALB still exists: $ALB_ARN"
              echo "Destroy may have failed or ALB is still being deleted"
              exit 1
            else
              echo "âœ… ALB successfully destroyed"
            fi
          else
            echo "â„¹ï¸  Could not determine ALB name, skipping verification"
          fi
        continue-on-error: true

      - name: Verify ASG is Destroyed
        run: |
          echo "ðŸ” Verifying Auto Scaling Group is destroyed..."
          
          if [ -n "${{ steps.pre-destroy.outputs.asg_name }}" ]; then
            ASG_NAME="${{ steps.pre-destroy.outputs.asg_name }}"
            # Try to find the ASG
            ASG_EXISTS=$(aws autoscaling describe-auto-scaling-groups \
              --region "${{ steps.backend-config.outputs.region }}" \
              --query "AutoScalingGroups[?AutoScalingGroupName=='${ASG_NAME}'].AutoScalingGroupName" \
              --output text 2>/dev/null || echo "")
            
            if [ -n "$ASG_EXISTS" ]; then
              echo "âŒ ASG still exists: $ASG_NAME"
              echo "Destroy may have failed or ASG is still being deleted"
              exit 1
            else
              echo "âœ… ASG successfully destroyed"
            fi
          else
            echo "â„¹ï¸  Could not determine ASG name, skipping verification"
          fi
        continue-on-error: true

      - name: Verify EC2 Instances are Terminated
        run: |
          echo "ðŸ” Verifying EC2 instances are terminated..."
          
          # Find any running instances with the project tag
          INSTANCES=$(aws ec2 describe-instances \
            --region "${{ steps.backend-config.outputs.region }}" \
            --filters "Name=tag:Project,Values=ami-healer" "Name=instance-state-name,Values=running,pending" \
            --query "Reservations[*].Instances[*].InstanceId" \
            --output text 2>/dev/null || echo "")
          
          if [ -n "$INSTANCES" ]; then
            echo "âŒ Found running instances: $INSTANCES"
            echo "Instances may still be terminating, but they should be stopped"
            # Don't fail here as instances might be in terminating state
            echo "âš ï¸  Warning: Some instances may still be terminating"
          else
            echo "âœ… No running instances found"
          fi
        continue-on-error: true

      - name: Verify VPC is Destroyed
        run: |
          echo "ðŸ” Verifying VPC is destroyed..."
          
          if [ -n "${{ steps.pre-destroy.outputs.vpc_id }}" ]; then
            VPC_ID="${{ steps.pre-destroy.outputs.vpc_id }}"
            # Try to find the VPC
            VPC_EXISTS=$(aws ec2 describe-vpcs \
              --region "${{ steps.backend-config.outputs.region }}" \
              --vpc-ids "$VPC_ID" \
              --query "Vpcs[0].VpcId" \
              --output text 2>/dev/null || echo "")
            
            if [ -n "$VPC_EXISTS" ] && [ "$VPC_EXISTS" != "None" ]; then
              echo "âŒ VPC still exists: $VPC_ID"
              echo "Destroy may have failed or VPC dependencies still exist"
              exit 1
            else
              echo "âœ… VPC successfully destroyed"
            fi
          else
            echo "â„¹ï¸  Could not determine VPC ID, skipping verification"
          fi
        continue-on-error: true

      - name: Verify Launch Template is Destroyed
        run: |
          echo "ðŸ” Verifying Launch Template is destroyed..."
          
          # Find any launch templates with the project name
          LT_EXISTS=$(aws ec2 describe-launch-templates \
            --region "${{ steps.backend-config.outputs.region }}" \
            --query "LaunchTemplates[?contains(LaunchTemplateName, 'ami-healer')].LaunchTemplateName" \
            --output text 2>/dev/null || echo "")
          
          if [ -n "$LT_EXISTS" ]; then
            echo "âš ï¸  Launch templates still exist: $LT_EXISTS"
            echo "This is expected as launch templates may persist after ASG deletion"
            echo "They will be cleaned up automatically by AWS"
          else
            echo "âœ… Launch templates destroyed"
          fi
        continue-on-error: true

      - name: Destroy Summary
        run: |
          echo "## ðŸ—‘ï¸ Infrastructure Destroyed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Verification Results:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Terraform destroy completed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… ALB verification completed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… ASG verification completed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… EC2 instances verification completed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… VPC verification completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Some resources may take a few minutes to fully delete. Check AWS Console to confirm." >> $GITHUB_STEP_SUMMARY
